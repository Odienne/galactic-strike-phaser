import{r as e}from"./phaser-y5S3hZEA.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var t=e();class s extends t.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("Preloader")}}class i{constructor(e,t){this.scene=e,this.enemyVideoManager=t,this.cols=10,this.rows=10,this.gridStartX=550,this.gridStartY=32,this.gridWidth=1330,this.gridHeight=996,this.cellWidth=this.gridWidth/this.cols,this.cellHeight=this.gridHeight/this.rows,this.ships=[],this.cellStatus=[];for(let s=0;s<this.rows;s++){this.cellStatus[s]=[];for(let e=0;e<this.cols;e++)this.cellStatus[s][e]="empty"}this.cellOverlays={},this.placeShipsRandomly(),this.initializeShips(),this.createGrid(),this.animateHighlights(),this.manageQtEvents()}createGrid(){const e=this.scene.add.graphics({lineStyle:{width:1,color:16777215,alpha:.2}});for(let t=0;t<=this.cols;t++){const s=this.gridStartX+t*this.cellWidth;e.strokeLineShape(new Phaser.Geom.Line(s,this.gridStartY,s,this.gridStartY+this.gridHeight))}for(let t=0;t<=this.rows;t++){const s=this.gridStartY+t*this.cellHeight;e.strokeLineShape(new Phaser.Geom.Line(this.gridStartX,s,this.gridStartX+this.gridWidth,s))}}animateHighlights(){const e=this.scene;this.createHighlights(),this.rowTween=e.tweens.add({targets:this.rowHighlight,y:{from:this.rowHighlight.y,to:this.gridStartY+this.gridHeight-this.cellHeight/2},duration:4e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),this.colTween=e.tweens.add({targets:this.colHighlight,x:{from:this.colHighlight.x,to:this.gridStartX+this.gridWidth-this.cellWidth/2},duration:4e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}),e.input.keyboard.on("keydown-Q",(()=>{this.qPressed||(this.qPressed=!0,this.rowTween.isPlaying()&&this.rowTween.pause(),this.checkForViewfinderAnimation(),this.chooseLockSound())})),e.input.keyboard.on("keyup-Q",(()=>{this.qPressed=!1,this.rowTween.isPaused()&&this.rowTween.resume(),this.checkForViewfinderAnimation()})),e.input.keyboard.on("keydown-D",(()=>{this.dPressed||(this.dPressed=!0,this.colTween.isPlaying()&&this.colTween.pause(),this.chooseLockSound(),this.checkForViewfinderAnimation())})),e.input.keyboard.on("keyup-D",(()=>{this.dPressed=!1,this.colTween.isPaused()&&this.colTween.resume(),this.checkForViewfinderAnimation()}))}initializeShips(){this.shipCells=[];const e=[5,3,2,2,1];for(let t of e){let e=!1;for(;!e;){const s=Math.random()<.5,i=s?this.cols-t:this.cols-1,a=s?this.rows-1:this.rows-t,r=Phaser.Math.Between(0,i),n=Phaser.Math.Between(0,a),o=[];for(let e=0;e<t;e++){const t=s?r+e:r,i=s?n:n+e;o.push({col:t,row:i})}o.some((e=>this.shipCells.some((t=>t.col===e.col&&t.row===e.row))))||(this.shipCells.push(...o),e=!0)}}}placeShipsRandomly(){const e=this.rows,t=this.cols;this.cellStatus=Array.from({length:e},(()=>Array(t).fill(null))),this.ships=[],[{size:5,spriteKey:"ship5"},{size:3,spriteKey:"ship3"},{size:2,spriteKey:"ship2a"},{size:2,spriteKey:"ship2b"},{size:1,spriteKey:"ship1"}].forEach((s=>{let i=!1;const a=s.size,r=s.spriteKey;for(;!i;){const s=Math.random()<.5,n=s?e-1:e-a,o=s?t-a:t-1,h=Phaser.Math.Between(0,n),l=Phaser.Math.Between(0,o);let d=!0;for(let e=0;e<a;e++){const t=h+(s?0:e),i=l+(s?e:0);if(null!==this.cellStatus[t][i]){d=!1;break}}if(d){const e={cells:[],hits:0,spriteKey:r,orientation:s?"horizontal":"vertical"};for(let t=0;t<a;t++){const i=h+(s?0:t),a=l+(s?t:0);this.cellStatus[i][a]={type:"ship",shipIndex:this.ships.length},e.cells.push({r:i,c:a})}this.ships.push(e),i=!0}}}))}fireAtCell(e,t){const s=Math.floor((e-this.gridStartX)/this.cellWidth),i=Math.floor((t-this.gridStartY)/this.cellHeight);if(s<0||s>=this.cols||i<0||i>=this.rows)return!1;const a=this.cellStatus[i][s];if("hit"===a||"miss"===a)return!1;const r=`${i}_${s}`;if(this.cellOverlays[r])return!1;let n=!1;if(a&&"ship"===a.type){n=!0,this.cellStatus[i][s]="hit";const e=this.ships[a.shipIndex];e.hits++,this.scene.score.add(10),e.hits===e.cells.length&&(this.revealShip(e),this.areAllShipsSunk()||this.enemyVideoManager.playRandomEnemyFuriousVideo())}else this.cellStatus[i][s]="miss";const o=this.gridStartX+s*this.cellWidth+this.cellWidth/2,h=this.gridStartY+i*this.cellHeight+this.cellHeight/2,l=n?16711680:16777215,d=n?.6:.4;return this.cellOverlays[r]=this.scene.add.rectangle(o,h,this.cellWidth,this.cellHeight,l,d).setOrigin(.5),this.areAllShipsSunk()&&this.enemyVideoManager.playRandomSurrenderVideo((()=>{this.pixelatedGridAnimation((()=>{this.resetShips()}))})),n}revealShip(e){this.addDebris(e);let t=!0;e.cells.length>1&&(t=e.cells[0].r===e.cells[1].r);const s=e.cells.map((e=>e.r)),i=e.cells.map((e=>e.c)),a=Math.min(...s),r=Math.max(...s),n=Math.min(...i),o=Math.max(...i),h=this.gridStartX+n*this.cellWidth+(o-n+1)*this.cellWidth/2,l=this.gridStartY+a*this.cellHeight+(r-a+1)*this.cellHeight/2;this.cellWidth,this.cellHeight;let d=e.spriteKey||`ship${e.cells.length}`;const c=this.scene.add.sprite(h,l,d).setOrigin(.5);t||(c.angle=90,c.setScale(.9)),c.setDepth(1),c.setAlpha(.7),e.sprite=c}randomOrientation(){return Math.random()<.5?"horizontal":"vertical"}areAllShipsSunk(){return this.ships.every((e=>e.hits>=e.cells.length))}resetShips(){for(let e=0;e<this.rows;e++)for(let t=0;t<this.cols;t++){this.cellStatus[e][t]={type:"empty"};const s=`${e}_${t}`;this.cellOverlays&&this.cellOverlays[s]&&(this.cellOverlays[s].destroy(),delete this.cellOverlays[s])}this.ships.forEach((e=>{e.sprite&&e.sprite.destroy()})),this.placeShipsRandomly()}pixelatedGridAnimation(e=null){const t=this.scene.bgVideo.postFX.addPixelate(-1);this.scene.bgVideo.setDepth(500),this.scene.tweens.addCounter({from:-1,to:30,duration:800,yoyo:!0,onUpdate:e=>{t.amount=e.getValue()},onComplete:()=>{this.scene.bgVideo.postFX.clear(),this.scene.bgVideo.setDepth(-11),e&&e()}})}createHighlights(){this.createRowHighlight(),this.createColumnHighlight()}createRowHighlight(){const e=this.cellHeight,t=this.scene.textures.createCanvas("rowGradient",1400,e),s=t.getContext(),i=s.createLinearGradient(0,0,0,e);i.addColorStop(0,"rgba(255, 255, 255,0)"),i.addColorStop(.5,"rgba(255, 255, 255,0.4)"),i.addColorStop(1,"rgba(255, 255, 255,0)"),s.fillStyle=i,s.fillRect(0,0,1400,e),t.refresh(),this.rowHighlight=this.scene.add.image(this.gridStartX+700,this.gridStartY+e/2,"rowGradient"),this.rowHighlight.setOrigin(.5),this.rowHighlight.setDepth(5)}createColumnHighlight(){const e=this.cellWidth,t=this.scene.textures.createCanvas("colGradient",e,1080),s=t.getContext(),i=s.createLinearGradient(0,0,e,0);i.addColorStop(0,"rgba(255, 255, 255,0)"),i.addColorStop(.5,"rgba(255, 255, 255,0.4)"),i.addColorStop(1,"rgba(255, 255, 255,0)"),s.fillStyle=i,s.fillRect(0,0,e,1080),t.refresh(),this.colHighlight=this.scene.add.image(this.gridStartX+e/2,this.gridStartY+540,"colGradient"),this.colHighlight.setOrigin(.5),this.colHighlight.setDepth(5)}addDebris(e){e.cells.forEach((({r:e,c:t})=>{const s=this.gridStartX+t*this.cellWidth+this.cellWidth/2,i=this.gridStartY+e*this.cellHeight+this.cellHeight/2;this.scene.add.particles(s,i,"explosion",{frame:"stone",angle:{min:240,max:300},speed:{min:400,max:800},lifespan:3200,alpha:{start:1,end:0},scale:{min:.05,max:.4},rotate:{start:0,end:360,ease:"Back.easeOut"},gravityY:800,on:!0}).explode(3)}))}checkForViewfinderAnimation(){this.qPressed&&this.dPressed?this.scene.viewfinder&&(this.scene.viewfinder.lockViewfinderAnimation(),this.scene.viewfinder.setAccentColorRectangles()):this.scene.viewfinder&&(this.scene.viewfinder.unlockViewfinderAnimation(),this.scene.viewfinder.resetAccentColorRectangles())}chooseLockSound(){return this.qPressed&&this.dPressed?this.scene.soundSystem.playDoubleLock():this.scene.soundSystem.playLock()}manageQtEvents(){window.updateKeyRow=e=>{this.qPressed=e,this.qPressed?(this.rowTween.isPlaying()&&this.rowTween.pause(),this.chooseLockSound()):this.rowTween.isPaused()&&this.rowTween.resume(),this.checkForViewfinderAnimation()},window.updateKeyColumn=e=>{this.dPressed=e,this.dPressed?(this.colTween.isPlaying()&&this.colTween.pause(),this.chooseLockSound()):this.colTween.isPaused()&&this.colTween.resume(),this.checkForViewfinderAnimation()}}}class a{constructor(e,t){this.scene=e,this.weaponSystem=t;const s=this.scene.grid;this.cellWidth=s.cellWidth,this.cellHeight=s.cellHeight,this.gridStartX=s.gridStartX,this.gridStartY=s.gridStartY,this.viewfinder=this.createViewfinderSprite(),this.highlightRects=this.createHighlightRectangles(9),this.highlightAlpha=.2}hide(){this.viewfinder.setVisible(!1)}show(){this.viewfinder.setVisible(!0)}createViewfinderSprite(){const e=this.scene.add.sprite(0,0,"viewfinder");return e.setOrigin(.5),e.setDepth(100),e.setVisible(!0),e}createHighlightRectangles(e){const t=[];for(let s=0;s<e;s++){const e=this.scene.add.rectangle(0,0,this.cellWidth,this.cellHeight,16749312,.2);e.setStrokeStyle(1.6,16749312,.8),e.setOrigin(.5),e.setDepth(90),e.setVisible(!1),t.push(e)}return t}update(e,t){const s=this.weaponSystem.currentWeapon;this.setWeaponStyle(s);const i=this.getGridColumnIndex(e.x),a=this.getGridRowIndex(t.y);if(!this.isValidGridPosition(i,a))return void this.hideAll();const r=this.getCellCenterPosition(i,a),n=this.calculateHighlightPositions(r,s);this.updateViewfinder(e.x,t.y),this.updateHighlightRects(n)}isValidGridPosition(e,t){return"number"==typeof e&&"number"==typeof t&&e>=0&&t>=0}getCellCenterPosition(e,t){return{x:this.gridStartX+e*this.cellWidth+this.cellWidth/2,y:this.gridStartY+t*this.cellHeight+this.cellHeight/2}}calculateHighlightPositions(e,t){const s=this.cellWidth,i=this.cellHeight;switch(t){case 1:default:return[e];case 2:return[{x:e.x-s,y:e.y},e,{x:e.x+s,y:e.y}];case 3:return[e,{x:e.x-s,y:e.y-i},{x:e.x+s,y:e.y-i},{x:e.x-s,y:e.y+i},{x:e.x+s,y:e.y+i},{x:e.x+s,y:e.y},{x:e.x-s,y:e.y},{x:e.x,y:e.y+i},{x:e.x,y:e.y-i}]}}hideAll(){this.viewfinder.setVisible(!1),this.highlightRects.forEach((e=>e.setVisible(!1)))}setWeaponStyle(e){switch(e){case 1:this.setHighlightStyle(16711680,.5,this.highlightAlpha),this.viewfinder.setTexture("viewfinder");break;case 2:this.setHighlightStyle(15101695,.5,this.highlightAlpha),this.viewfinder.setTexture("viewfinder2");break;case 3:this.setHighlightStyle(16749312,.5,this.highlightAlpha),this.viewfinder.setTexture("viewfinder3");break;default:this.setHighlightStyle(16711680,.5,this.highlightAlpha),this.viewfinder.setTexture("viewfinder1")}}setHighlightStyle(e,t,s){this.highlightRects.forEach((i=>{i.setStrokeStyle(1.6,e,t),i.setFillStyle(e,s)}))}getGridColumnIndex(e){return Math.floor((e-this.gridStartX)/this.cellWidth)}getGridRowIndex(e){return Math.floor((e-this.gridStartY)/this.cellHeight)}updateViewfinder(e,t){this.viewfinder.setPosition(e,t)}updateHighlightRects(e){this.highlightRects.forEach(((t,s)=>{e[s]?(t.setPosition(e[s].x,e[s].y),t.setVisible(!0)):t.setVisible(!1)}))}setAccentColorRectangles(){this.highlightAlpha=.4}resetAccentColorRectangles(){this.highlightAlpha=.2}lockViewfinderAnimation(){const e=this.viewfinder;e.setScale(1),e.setAngle(0),this.scene.tweens.add({targets:e,scale:.8,angle:135,duration:200,ease:"Cubic.easeOut",yoyo:!1})}unlockViewfinderAnimation(){const e=this.viewfinder;this.scene.tweens.add({targets:e,scale:1,angle:0,duration:200,ease:"Cubic.easeOut",yoyo:!1})}}window.setLanguage=e=>(console.log(e),e);class r{constructor(e,t,s){this.scene=e,this.soundSystem=s,this.grid=t,this.currentWeapon=1,this.setupInput(),window.setWeapon=this.setWeapon,window.updateKeyFire=()=>{this.fire()}}setWeapon(e){return this.currentWeapon=e}setupInput(){["ONE","TWO","THREE"].forEach(((e,t)=>{this.scene.input.keyboard.on(`keydown-${e}`,(()=>{this.currentWeapon=t+1}))})),this.scene.input.keyboard.on("keydown-SPACE",(()=>this.fire()))}async fire(){var e,t;if(!(await this.scene.socket.isWeaponOffCoolDown())||(!this.grid.qPressed||!this.grid.dPressed)&&2!==window.nbPlayers)return this.soundSystem.playCantFire(),!1;const s=this.grid.colHighlight.x,i=this.grid.rowHighlight.y,a=this.grid.cellWidth,r=this.grid.cellHeight;this.scene.scale.width,this.scene.scale.height;let n=[],o="laser";const h=((null==(t=null==(e=this.scene)?void 0:e.scale)?void 0:t.height)??1080)-50;switch(this.currentWeapon){case 1:o="laser",n=[{startX:1215,startY:h,targetX:s,targetY:i}];break;case 2:o="laser2",n=[{startX:550,startY:h,targetX:s-a,targetY:i},{startX:1215,startY:h,targetX:s,targetY:i},{startX:1900,startY:h,targetX:s+a,targetY:i}];break;case 3:o="laser3",n=[{startX:1215,startY:h,targetX:s,targetY:i},{startX:1215,startY:h,targetX:s-a,targetY:i},{startX:1215,startY:h,targetX:s-a,targetY:i-r},{startX:1215,startY:h,targetX:s+a,targetY:i},{startX:1215,startY:h,targetX:s+a,targetY:i-r},{startX:1215,startY:h,targetX:s-a,targetY:i+r},{startX:1215,startY:h,targetX:s,targetY:i-r},{startX:1215,startY:h,targetX:s,targetY:i+r},{startX:1215,startY:h,targetX:s+a,targetY:i+r}]}n.forEach((e=>{const t=e.startX,s=e.startY,i=e.targetX,a=e.targetY;this.fireLaser(t,s,i,a,o)})),this.scene.socket.updateWeaponCooldown()}fireLaser(e,t,s,i,a){this.soundSystem.playLaser(this.currentWeapon);const r=s,n=i,o=this.selectSpeed(),h=Phaser.Math.Distance.Between(e,t,r,n)/o*1e3,l=this.scene.add.sprite(e,t,a).setDepth(10).setBlendMode(Phaser.BlendModes.ADD);switch(this.currentWeapon){case 1:case 3:l.setOrigin(.5,.2);break;case 2:l.setOrigin(.5,.4)}this.scene.tweens.add({targets:l,scaleX:{from:1,to:1.6},duration:100,yoyo:!0,repeat:-1});const d=Phaser.Math.Angle.Between(e,t,s,i);l.rotation=d+Math.PI/2,this.scene.tweens.add({targets:l,x:r,y:n,duration:h,ease:"Linear",onComplete:()=>{this.grid.fireAtCell(s,i)&&(this.showExplosion(s,i),this.soundSystem.playExplosion()),this.scene.tweens.add({targets:l,alpha:0,duration:100,onComplete:()=>l.destroy()})}})}showExplosion(e,t){const s=this.selectExplosionSprite(e,t);this.playSelectedExplosion(s),s.on("animationcomplete",(()=>s.destroy()))}selectExplosionSprite(e,t){switch(this.currentWeapon){case 1:default:return this.scene.add.sprite(e,t,"explosion1").setScale(2.3);case 2:return this.scene.add.sprite(e,t,"explosion2").setScale(2.8);case 3:return this.scene.add.sprite(e,t,"explosion3").setScale(3.2)}}playSelectedExplosion(e){switch(this.currentWeapon){case 1:default:return e.play("explode1");case 2:return e.play("explode2");case 3:return e.play("explode3")}}selectSpeed(){switch(this.currentWeapon){case 1:default:return 3600;case 2:return 3e3;case 3:return 1200}}}class n extends t.Scene{constructor(){super("GameOver")}create(){this.cameras.main.setBackgroundColor(0),this.add.text(960,540,"Temps écoulé",{fontFamily:"GothamNarrow",fontSize:64,color:"#ffffff",align:"center"}).setOrigin(.5,.5)}}class o{constructor(e){this.scene=e,this.duration=180,this.text=e.add.text(146,22,"Temps restant : "+this.formatTime(this.duration),{fontSize:"22px",fontWeight:"bold",letterSpacing:3,color:"#ffffff",fontFamily:"GothamNarrow"}).setOrigin(0,0).setDepth(1e4),this.timerEvent=e.time.addEvent({delay:1e3,callback:this.tick,callbackScope:this,loop:!0})}tick(){var e;this.duration--,this.text.setText("Temps restant : "+this.formatTime(this.duration)),this.duration<=0&&(this.timerEvent.remove(),this.transitionToGameOver()),e=180-this.duration,window.sendToQt({time:e})}formatTime(e){const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}destroy(){this.text.destroy(),this.timerEvent.remove()}transitionToGameOver(){const e=this.scene.cameras.main.postFX.addPixelate(-1);this.scene.add.tween({targets:e,duration:700,amount:40,onComplete:()=>{this.scene.cameras.main.fadeOut(100),this.scene.enemyAttackSystem.destroy(),this.scene.scene.start("GameOver")}})}}class h{constructor(e){this.score=0,this.scene=e,this.scoreText=this.scene.add.text(200,720,`SCORE: ${this.score}`,{fontSize:"52px",color:"#ffffff",fontFamily:"American Captain"}).setDepth(1e4)}add(e){var t;e<0?this.animateLosePoints():this.animateGainPoints(),this.score+=e,this.scoreText.setText(`Score: ${this.score}`),t=this.score,window.sendToQt({score:t})}animateLosePoints(){this.setRedGlow(!0),this.scene.tweens.add({targets:this.scoreText,alpha:.2,duration:100,yoyo:!0,repeat:3,onComplete:()=>{this.setRedGlow(!1),this.scoreText.setAlpha(1),this.scoreText.setScale(1)}})}animateGainPoints(){this.setGreenGlow(!0),this.scene.tweens.add({targets:this.scoreText,alpha:.2,duration:80,yoyo:!0,repeat:3,onComplete:()=>{this.setGreenGlow(!1),this.scoreText.setAlpha(1),this.scoreText.setScale(1)}})}setRedGlow(e){e?this.scoreText.setColor("#ff0000"):this.scoreText.setColor("#ffffff")}setGreenGlow(e){e?this.scoreText.setColor("#00ff00"):this.scoreText.setColor("#ffffff")}}class l{constructor(e,t,s,i,a){this.scene=e,this.scoreModule=t,this.systemVideoManager=s,this.enemyVideoManager=i,this.soundSystem=a,this.attackBox=null,this.currentAttackSide=null,this.attackTimeoutId=null,this.defendTimeoutId=null,this.canDefend=!1,this.handleKeyDown=this.handleKeyDown.bind(this),window.addEventListener("keydown",this.handleKeyDown),this.attackScheduled=!1,this.scheduleNextAttack(!0),this.createAttackFlash(),window.defendLeft=()=>{this.canDefend&&this.currentAttackSide&&"left"===this.currentAttackSide&&this.resolveAttack(!0)},window.defendRight=()=>{this.canDefend&&this.currentAttackSide&&"right"===this.currentAttackSide&&this.resolveAttack(!0)}}nextRandomAttackTimer(){let e=12e3,t=2e4;return this.scene.timer.duration<120?(e=8e3,t=14e3):this.scene.timer.duration<60&&(e=6e3,t=1e4),Math.random()*(t-e)+e}async scheduleNextAttack(e=!1){this.attackScheduled?console.warn("Attack already scheduled, skipping"):(this.attackScheduled=!0,this.attackTimeoutId&&(clearTimeout(this.attackTimeoutId),this.attackTimeoutId=null),await this.systemVideoManager.changeVideo("computerIdle"),this.attackTimeoutId=setTimeout((()=>{this.attackScheduled=!1,this.triggerAttack(e)}),this.nextRandomAttackTimer()))}async triggerAttack(e=!1){e?this.enemyVideoManager.playRandomEnemyAttackVideo((()=>{this.handleAttackBoxAndDefendTimer()})):this.handleAttackBoxAndDefendTimer()}async handleAttackBoxAndDefendTimer(){await this.systemVideoManager.changeVideo("computerDanger"),this.canDefend=!0,this.currentAttackSide=Math.random()<.5?"left":"right",this.flashAttack(this.currentAttackSide),this.defendTimeoutId=setTimeout((()=>{this.resolveAttack(!1),this.attackScheduled=!1}),2e3)}handleKeyDown(e){if(!this.canDefend||!this.currentAttackSide)return;const t=e.key.toLowerCase();("k"===t&&"left"===this.currentAttackSide||"l"===t&&"right"===this.currentAttackSide)&&this.resolveAttack(!0)}async resolveAttack(e){this.canDefend&&(this.canDefend=!1,this.defendTimeoutId&&(clearTimeout(this.defendTimeoutId),this.defendTimeoutId=null),e?(this.soundSystem.playAttackParried(),this.scoreModule.add(10),this.setAttackBoxDefended()):(this.soundSystem.playPlayerShipExplosion(),this.clearAttackTween(),this.triggerScreenShake(),this.scoreModule.add(-30),this.scene.time.delayedCall(800,(()=>{this.enemyVideoManager.playRandomEnemyMockingVideo()}))),this.scheduleNextAttack())}createAttackFlash(){const e=this.scene.scale.width;this.attackFlashLeft=this.scene.add.image(0,0,"redAlertLeft").setOrigin(0,0).setDisplaySize(400,1080).setDepth(1e3).setAlpha(0).setVisible(0),this.attackFlashRight=this.scene.add.image(e,0,"redAlertRight").setOrigin(1,0).setDisplaySize(400,1080).setDepth(1e3).setAlpha(0).setVisible(0)}flashAttack(e="left"){this.target=this.attackFlashLeft,this.target="right"===e?this.attackFlashRight:this.attackFlashLeft,this.target.setVisible(!0),this.target.setAlpha(1),this.target.setTintFill(16711680),this.currentTweenAttack=this.scene.tweens.add({targets:this.target,scaleX:{from:.8,to:1.3},alpha:{from:.6,to:1},duration:500,yoyo:!0,repeat:4,ease:"Cubic.easeOut",onComplete:()=>{this.hideTarget()}})}destroy(){window.removeEventListener("keydown",this.handleKeyDown),this.attackTimeoutId&&clearTimeout(this.attackTimeoutId),this.defendTimeoutId&&clearTimeout(this.defendTimeoutId)}triggerScreenShake(){this.redFlashOverlay||(this.redFlashOverlay=this.scene.add.graphics(),this.redFlashOverlay.fillStyle(16711680,.5),this.redFlashOverlay.fillRect(0,0,this.scene.scale.width,this.scene.scale.height),this.redFlashOverlay.setScrollFactor(0),this.redFlashOverlay.setDepth(1e3)),this.redFlashOverlay.setAlpha(0),this.redFlashOverlay.setVisible(!0),this.scene.tweens.killTweensOf(this.redFlashOverlay),this.scene.tweens.add({targets:this.redFlashOverlay,alpha:{from:1,to:.6},duration:200,yoyo:!0,repeat:1,ease:"Cubic.easeOut",onComplete:()=>{this.redFlashOverlay.setVisible(!1)}}),this.scene.cameras.main.shake(1e3,.03)}clearAttackTween(){this.currentTweenAttack&&(this.currentTweenAttack.complete(),this.hideTarget())}setAttackBoxDefended(){this.target.setTintFill(65280),this.currentTweenAttack&&this.currentTweenAttack.stop(),setTimeout((()=>{this.clearAttackTween()}),600)}hideTarget(){this.target.setVisible(!1),this.target.setAlpha(0)}}class d{constructor(e){this.scene=e,this.videoMap={computerIdle:this.scene.add.video(42,786,"computerIdle").setOrigin(0,0).setDepth(400).setVisible(!0),computerDanger:this.scene.add.video(42,786,"computerDanger").setOrigin(0,0).setDepth(400).setVisible(!0).setVolume(.4)},this.changeVideo("computerIdle")}async changeVideo(e){return void 0!==this.currentVideo&&(this.currentVideo.setDepth(300),this.currentVideo.stop()),this.currentVideo=this.videoMap[e],this.currentVideo.setCurrentTime(0),new Promise((e=>{const t=()=>{this.currentVideo.off("play",t),this.currentVideo.setDisplaySize(477,270),this.currentVideo.setDepth(400)};this.currentVideo.once("play",t),this.currentVideo.setDepth(400),this.currentVideo.play(!0),e()}))}}class c{constructor(e){this.scene=e,this.videosKeys={standBy:["enemyStandBy"],attack:["enemyAttack01","enemyAttack02"],furious:["enemyFurious01","enemyFurious02","enemyFurious03","enemyFurious04"],mocking:["enemyMocking01","enemyMocking02","enemyMocking03","enemyMocking04"],surrender:["enemySurrender01","enemySurrender02"]},this.videosObjects=[],Object.keys(this.videosKeys).forEach((e=>{this.videosKeys[e].forEach((t=>{void 0===this.videosObjects[e]&&(this.videosObjects[e]={}),this.videosObjects[e][t]=this.scene.add.video(42,42,t).setOrigin(0,0).setDepth(300)}))})),this.playVideo(this.videosObjects.standBy.enemyStandBy,!0,!1)}selectRandomVideo(e,t=!1,s=!0,i=null){const a=this.videosKeys[e][Math.floor(Math.random()*this.videosKeys[e].length)];return this.playVideo(this.videosObjects[e][a],t,s,i),this.videosObjects[e][a]}playRandomSurrenderVideo(e=null){return this.selectRandomVideo("surrender",!1,!0,e)}playRandomEnemyFuriousVideo(e=null){return this.selectRandomVideo("furious",!1,!0,e)}playRandomEnemyAttackVideo(e=null){return this.selectRandomVideo("attack",!1,!0,e)}playRandomEnemyMockingVideo(){return this.selectRandomVideo("mocking")}playVideo(e,t=!1,s=!0,i=null){if(void 0!==this.currentVideo&&this.currentVideo.isPlaying()&&this.currentVideo!==this.videosObjects.standBy.enemyStandBy)return i&&setTimeout((()=>{i()}),1e3),!1;void 0!==this.currentVideo&&(this.currentVideo.setDepth(300),this.currentVideo.stop());try{this.currentVideo=e,e.setVisible(!0),e.play(t),e.setDepth(500),e.once("play",(()=>{e.setDisplaySize(473,650)})),s&&e.once("complete",(()=>{this.selectRandomVideo("standBy",!0,!1)})),i&&e.once("complete",(()=>{i()}))}catch(a){console.warn("Video play failed:",a)}}}const p={bgm:{id:"1",name:"bgm",src:"assets/bgm/01-bgm.mp3",description:"BGM music",object:null},laser1:{id:"2",name:"laser1",src:"assets/sfx/02-laser1.mp3",description:"Played when player presses the fire button (weapon 1)",object:null},laser2:{id:"3",name:"laser2",src:"assets/sfx/03-laser2.mp3",description:"Played when player presses the fire button (weapon 2)",object:null},laser3:{id:"4",name:"laser3",src:"assets/sfx/04-laser3.mp3",description:"Played when player presses the fire button (weapon 3)",object:null},"ship-explosion":{id:"5",name:"ship_explosion",src:"assets/sfx/05-ship_explosion.mp3",description:"Played when ship is sunk",object:null},"player-explosion":{id:"6",name:"player_explosion",src:"assets/sfx/06-player_explosion.mp3",description:"Played when player is hit",object:null},"curtain-open":{id:"7",name:"curtain_open",src:"assets/sfx/07-curtain_open.mp3",description:"Played when player is hit",object:null},"attack-parried":{id:"8",name:"attack_parried",src:"assets/sfx/08-attack_parried.mp3",description:"Played when player parry an attack",object:null},"cant-fire":{id:"9",name:"cantFire",src:"assets/sfx/09-cantFire.mp3",description:"Played when player tries to fire without locking row and column",object:null},lock:{id:"10",name:"lock",src:"assets/sfx/10-lock.mp3",description:"Played when player lock a row or a column",object:null},double_lock:{id:"11",name:"double_lock",src:"assets/sfx/11-double_lock.mp3",description:"Played when player locked row and column",object:null}};class u{constructor(e){this.scene=e,this.bgm=this.scene.sound.add("bgm"),this.curtainOpen=this.scene.sound.add("curtain_open"),this.shipExplosion=this.scene.sound.add("ship_explosion"),this.attackParried=this.scene.sound.add("attack_parried"),this.playerShipExplosion=this.scene.sound.add("player_explosion"),this.laser1=this.scene.sound.add("laser1"),this.laser2=this.scene.sound.add("laser2"),this.laser3=this.scene.sound.add("laser3"),this.cantFire=this.scene.sound.add("cantFire"),this.lock=this.scene.sound.add("lock"),this.doubleLock=this.scene.sound.add("double_lock"),this.playBgm()}playBgm(){this.shipExplosion.setVolume(1),this.bgm.play()}playExplosion(){this.shipExplosion.setVolume(.3),this.shipExplosion.play()}playAttackParried(){this.attackParried.setVolume(.8),this.attackParried.play()}playCantFire(){this.cantFire.setVolume(.8),this.cantFire.play()}playLock(){this.lock.setVolume(.8),this.lock.play()}playDoubleLock(){this.doubleLock.setVolume(.8),this.doubleLock.play()}playPlayerShipExplosion(){this.playerShipExplosion.setVolume(.4),this.playerShipExplosion.play()}playCurtainOpen(){this.curtainOpen.setVolume(1),this.curtainOpen.play()}playLaser(e){switch(e){case 1:this.laser1.setVolume(.3),this.laser1.play();break;case 2:this.laser2.setVolume(.3),this.laser2.play();break;case 3:this.laser3.setVolume(.3),this.laser3.play()}}destroy(){this.bgm.destroy()}}class g{constructor(e){this.scene=e,this.socket=new WebSocket("ws://localhost:3000"),this.clientId="Game Screen",this.pendingRequests=[],this.socket.onopen=e=>this.onOpen(e),this.socket.onclose=e=>this.onClose(e),this.socket.onmessage=e=>this.onMessage(e.data)}onOpen(){console.log("Connection ok"),this.socket.send(JSON.stringify({type:"register",from:this.clientId}))}onClose(){console.log("Connection lost")}async onMessage(e){var t;console.log(e);const s=JSON.parse(e);if("response"===s.type&&s.requestId){const e=this.pendingRequests[s.requestId];e&&(e(s.payload.result),delete this.pendingRequests[s.requestId])}if("request"===s.type&&(null==(t=s.payload)?void 0:t.func)){let e=null;"setWeapon"===s.payload.func&&(e=await this.scene.weaponSystem.setWeapon(s.payload.weaponId)),this.socket.send(JSON.stringify({type:"response",from:this.clientId,to:s.from,payload:{result:e},requestId:s.requestId}))}}isWeaponOffCoolDown(){return new Promise((e=>{const t=crypto.randomUUID();this.pendingRequests[t]=e,this.socket.send(JSON.stringify({type:"request",from:this.clientId,to:"Weapon Screen",payload:{func:"isWeaponOffCoolDown"},requestId:t}))}))}updateWeaponCooldown(){const e=crypto.randomUUID();this.socket.send(JSON.stringify({type:"request",from:this.clientId,to:"Weapon Screen",payload:{func:"updateWeaponCooldown"},requestId:e}))}}class m extends Phaser.Scene{constructor(){super("Game")}create(){!function(e){const t=e.add.image(e.scale.width/2,0,"uiOverlay").setOrigin(.5,0).setDepth(1e3),s=e.scale.width/t.width;t.setScale(s)}(this),this.socket=new g(this),this.score=new h(this),this.timer=new o(this),this.soundSystem=new u(this),this.enemyVideoManager=new c(this),this.systemVideoManager=new d(this),this.grid=new i(this,this.enemyVideoManager),this.bgVideo=function(e,t,s,i,a){const r=e.add.image(t,s,"bgFallback").setOrigin(0,0).setDepth(-11),n=e.add.video(0,0,"bgVideo").setDepth(-10).setOrigin(0,0),o=n.video;o.addEventListener("error",(()=>{console.warn("Video failed to load, using fallback image.")})),o.addEventListener("loadedmetadata",(()=>{h(),r.setVisible(!1)})),o.readyState>=2&&(h(),r.setVisible(!1));try{n.play(!0)}catch(l){console.warn("Autoplay failed:",l)}function h(){const e=o.videoWidth,r=o.videoHeight,h=i/e,l=a/r,d=Math.max(h,l);n.setScale(d),n.setPosition(t,s)}return n}(this,this.grid.gridStartX,this.grid.gridStartY,this.grid.gridWidth,this.grid.gridHeight),this.generatesTextures(),this.placeCurtains(),setTimeout((()=>{this.enemyVideoManager.playRandomEnemyAttackVideo((()=>this.startPlayerGamePlay()))}),3e3)}startPlayerGamePlay(){this.weaponSystem=new r(this,this.grid,this.soundSystem),this.viewfinder=new a(this,this.weaponSystem),this.enemyAttackSystem=new l(this,this.score,this.systemVideoManager,this.enemyVideoManager,this.soundSystem),this.slideCurtains()}update(){this.viewfinder&&this.viewfinder.update(this.grid.colHighlight,this.grid.rowHighlight)}generatesTextures(){const e=100/1.2;this.anims.create({key:"explode1",frames:this.anims.generateFrameNumbers("explosion1",{start:0,end:63,first:0}),frameRate:e,hideOnComplete:!0}),this.anims.create({key:"explode2",frames:this.anims.generateFrameNumbers("explosion2",{start:0,end:63,first:0}),frameRate:e,hideOnComplete:!0}),this.anims.create({key:"explode3",frames:this.anims.generateFrameNumbers("explosion3",{start:0,end:63,first:0}),frameRate:e,hideOnComplete:!0})}slideCurtains(){this.soundSystem.playCurtainOpen(),this.tweens.add({targets:this.topCurtain,y:-this.topCurtain.displayHeight,ease:"Power2",duration:3600}),this.tweens.add({targets:this.bottomCurtain,y:1080,ease:"Power2",duration:3600})}placeCurtains(){this.topCurtain=this.add.image(550,0,"top-curtain").setDepth(200).setOrigin(0,0),this.topCurtain.setDisplaySize(this.grid.gridWidth,540),this.bottomCurtain=this.add.image(550,540,"bottom-curtain").setDepth(200).setOrigin(0,0),this.bottomCurtain.setDisplaySize(this.grid.gridWidth,540)}}class y extends t.Scene{constructor(){super("Preloader")}init(){this.add.rectangle(960,510,570,60).setStrokeStyle(1,16777215).setOrigin(.5);const e=this.add.rectangle(679,510,4,56,16777215).setOrigin(.5);this.load.on("progress",(t=>{e.width=570*t-4}))}preload(){this.load.image("uiOverlay","assets/ui-overlay.png"),this.load.image("redAlertLeft","assets/red-alert-gradient-left.png"),this.load.image("redAlertRight","assets/red-alert-gradient-right.png"),this.load.image("viewfinder","assets/viewfinder.png"),this.load.image("viewfinder2","assets/viewfinder2.png"),this.load.image("viewfinder3","assets/viewfinder3.png"),this.load.image("bgFallback","assets/bg.png"),this.load.image("top-curtain","assets/top-curtain.png"),this.load.image("bottom-curtain","assets/bottom-curtain.png"),this.load.image("laser","assets/laser.png"),this.load.image("laser2","assets/laser2.png"),this.load.image("laser3","assets/laser3.png"),this.load.video("computerIdle","assets/videos/computer/computer-idle.webm"),this.load.video("computerDanger","assets/videos/computer/computer-danger.webm"),this.load.video("bgVideo","assets/bg_video.webm",!0),this.load.spritesheet("explosion1","assets/explosions/explosion1.png",{frameWidth:128,frameHeight:128,endFrame:63}),this.load.spritesheet("explosion2","assets/explosions/explosion2.png",{frameWidth:128,frameHeight:128,endFrame:63}),this.load.spritesheet("explosion3","assets/explosions/explosion3.png",{frameWidth:128,frameHeight:128,endFrame:63}),this.load.spritesheet("explosionFinal","assets/explosion-final.png",{frameWidth:128,frameHeight:128,endFrame:63}),this.load.image("ship5","assets/ships/ship5.png"),this.load.image("ship3","assets/ships/ship3.png"),this.load.image("ship2a","assets/ships/ship2a.png"),this.load.image("ship2b","assets/ships/ship2b.png"),this.load.image("ship1","assets/ships/ship1.png"),this.load.atlas("explosion","assets/particles/explosion.png","assets/particles/explosion.json"),this.loadFonts(),this.preloadAudio(),this.preloadEnemyVideos()}create(){this.scene.start("Game")}loadFonts(){this.loadFont("American Captain","assets/fonts/AmericanCaptain/AmericanCaptain.otf"),this.loadFont("GothamNarrow","assets/fonts/Gotham/GothamNarrow-Medium.otf")}loadFont(e,t){new FontFace(e,`url(${t})`).load().then((function(e){document.fonts.add(e)})).catch((function(e){return e}))}preloadAudio(){Object.entries(p).forEach((e=>{this.load.audio(e[1].name,e[1].src)}))}preloadEnemyVideos(){this.load.video("enemyStandBy","assets/videos/enemy/enemy-standby.webm",!0),this.load.video("enemyAttack01","assets/videos/enemy/enemy-attack-01.webm"),this.load.video("enemyAttack02","assets/videos/enemy/enemy-attack-02.webm"),this.load.video("enemyFurious01","assets/videos/enemy/enemy-furious-01.webm"),this.load.video("enemyFurious02","assets/videos/enemy/enemy-furious-02.webm"),this.load.video("enemyFurious03","assets/videos/enemy/enemy-furious-03.webm"),this.load.video("enemyFurious04","assets/videos/enemy/enemy-furious-04.webm"),this.load.video("enemyMocking01","assets/videos/enemy/enemy-mocking-01.webm"),this.load.video("enemyMocking02","assets/videos/enemy/enemy-mocking-02.webm"),this.load.video("enemyMocking03","assets/videos/enemy/enemy-mocking-03.webm"),this.load.video("enemyMocking04","assets/videos/enemy/enemy-mocking-04.webm"),this.load.video("enemySurrender01","assets/videos/enemy/enemy-surrender-01.webm"),this.load.video("enemySurrender02","assets/videos/enemy/enemy-surrender-02.webm")}}const f={type:Phaser.WEBGL,width:1920,height:1080,parent:"game-container",scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:1920,height:1080},scene:[s,y,m,n],fps:{target:60,forceSetTimeOut:!0},render:{antialias:!0,roundPixels:!1,maxTextures:20,batchSize:4096,clearBeforeRender:!0,failIfMajorPerformanceCaveat:!1,transparent:!1}};document.addEventListener("DOMContentLoaded",(()=>{new t.Game({...f,parent:"game-container"})}));
